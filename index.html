<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HAIR Style - Prueba peinados 2025 con IA</title>
  <meta name="description" content="Prueba los peinados más modernos de 2025 con IA. Sube tu foto y elige entre los estilos más trendings." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff;
      --text:#0f172a;
      --muted:#596377;
      --card:#f6f7fb;
      --border:#e5e7eb;
      --accent:#7c3aed;
      --accent-2:#ec4899;
      --shadow:0 10px 30px rgba(2,6,23,.08);
    }
    body.dark{
      --bg:#0b1220;
      --text:#e6eaf3;
      --muted:#9aa4b2;
      --card:#0f172a;
      --border:#1f2937;
      --shadow:0 10px 30px rgba(0,0,0,.45);
    }
    *{
      box-sizing:border-box
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      line-height:1.55;
    }
    a{
      color:inherit;
      text-decoration:none
    }
    .container{
      max-width:1200px;
      margin:0 auto;
      padding:0 20px
    }
    header{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:saturate(140%) blur(6px);
      background:color-mix(in srgb, var(--bg) 92%, transparent);
      border-bottom:1px solid var(--border);
    }
    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      height:64px;
      gap:16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      font-size:18px
    }
    .brand .dot{
      width:12px;
      height:12px;
      border-radius:50%;
      background:linear-gradient(135deg,var(--accent),var(--accent-2))
    }
    .right{
      display:flex;
      align-items:center;
      gap:10px
    }
    .apikey{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--card)
    }
    .apikey input{
      border:none;
      background:transparent;
      outline:none;
      color:var(--text);
      width:220px
    }
    .mini-btn{
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size: 14px;
    }
    .btn{
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#fff;
      border:none;
      padding:12px 18px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size: 14px;
    }
    .btn[disabled]{
      opacity:.6;
      cursor:not-allowed
    }
    .theme-toggle{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:38px;
      height:38px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--bg);
      cursor:pointer
    }
    body.dark .theme-toggle { background: var(--card); }
    .theme-toggle svg{
      width:18px;
      height:18px
    }
    /* hero */
    .hero{
      padding:56px 0 28px
    }
    .hero h1{
      font-size:44px;
      line-height:1.05;
      margin:0 0 8px;
      font-weight:800;
      letter-spacing:-0.02em;
      text-wrap:balance;
      text-align:center
    }
    .hero p{
      color:var(--muted);
      text-align:center;
      margin:0 0 26px
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      gap:28px;
      align-items:flex-start;
    }
    @media (max-width:980px){
      .grid{
        display: flex;
        flex-direction: column;
      }
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:20px;
    }
    /* Peinados */
    .hairstyles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
    }
    .hairstyle-item {
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      padding: 8px;
      text-align: center;
      transition: all .2s ease;
    }
    .hairstyle-item:hover {
      border-color: var(--accent-2);
      background: color-mix(in srgb, var(--card) 50%, transparent);
    }
    .hairstyle-item.selected {
      border-color: var(--accent);
      box-shadow: 0 0 15px color-mix(in srgb, var(--accent) 30%, transparent);
    }
    .hairstyle-item img {
      width: 100%;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .hairstyle-name {
      font-weight: 600;
      font-size: 14px;
    }
    .hairstyle-description {
      font-size: 14px;
      color: var(--muted);
      margin-top: 12px;
      display: none; /* Se muestra con JS */
    }
    /* Uploader */
    .uploader-card {
      position: sticky;
      top: 80px;
    }
    .drop{
      display:flex;
      flex-direction:column;
      gap:12px;
      justify-content:center;
      align-items:center;
      min-height:300px;
      border:2px dashed var(--border);
      border-radius:12px;
      background:color-mix(in srgb,var(--card) 85%, transparent);
      text-align:center;
      padding:16px;
      position: relative;
    }
    .drop.dragover{
      border-color:var(--accent-2);
      background:color-mix(in srgb,var(--card) 70%, transparent)
    }
    .drop .hint{
      color:var(--muted)
    }
    .helper{
      font-size:12px;
      color:var(--muted)
    }
    /* Resultados */
    .result-container {
      padding: 20px 0;
    }
    .result-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 15px;
      text-align: center;
    }
    .result-image-wrapper {
      display: flex;
      justify-content: center;
    }
    .result-image-wrapper img {
      max-width: 100%;
      max-height: 500px;
      border-radius: 8px;
      object-fit: contain;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    /* Footer */
    footer{
      border-top:1px solid var(--border);
      padding:26px 0;
      color:var(--muted);
      font-size:14px;
      text-align: center;
    }
    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:var(--card);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:10px;
      box-shadow:var(--shadow);
      display:none;
      z-index: 100;
    }
    .toast.show{
      display:block
    }
    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 250px;
      border-radius: 8px;
      display: none;
      margin-bottom: 15px;
    }
    
    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(0,0,0,.5);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      z-index: 5;
    }
    .close-btn svg {
      width: 18px;
      height: 18px;
    }
    
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      margin: 10px 0;
      display: none;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 5px;
      display: none;
    }
    
    @media (max-width: 768px) {
      .hero h1 { font-size: 32px; }
      .apikey { flex-wrap: wrap; justify-content: center; }
      .apikey input { width: 150px; }
      .controls { flex-direction: column; align-items: stretch; gap: 10px; }
      .btn, .mini-btn { width: 100%; text-align: center; }
    }
    
    @media (max-width: 480px) {
      .nav { flex-direction: column; height: auto; padding: 10px 0; }
      .right { width: 100%; justify-content: center; margin-top: 10px; }
      .hero { padding: 30px 0 20px; }
      .card { padding: 15px; }
      .section { padding: 40px 0; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <span class="dot"></span>
        <span>HAIR Style</span>
      </div>
      <div class="right">
        <div class="apikey" title="Tu clave se guarda en localStorage">
          <span style="font-size:12px;color:var(--muted)">API Key:</span>
          <input id="apiKeyInput" type="password" placeholder="GEMINI_API_KEY" />
          <button class="mini-btn" id="saveKeyBtn">Guardar</button>
        </div>
        <button class="theme-toggle" id="themeBtn" aria-label="Cambiar tema">
          <svg id="iconSun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"></path>
          </svg>
          <svg id="iconMoon" viewBox="0 0 24 24" fill="currentColor" style="display:none">
            <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <main>
    <section class="hero container">
      <h1>Prueba un nuevo look con IA</h1>
      <p>Sube tu foto, elige un estilo y deja que la magia suceda. ¡Así de fácil!</p>

      <div class="grid">
        <!-- Selección de Peinados -->
        <div class="card">
          <h2>1. Elige un estilo</h2>
          <p class="helper" id="hairstyle-description-display">Selecciona un corte para ver su descripción.</p>
          <div class="hairstyles-grid" id="hairstylesGrid">
            <!-- Los peinados se agregarán con JavaScript -->
          </div>
        </div>

        <!-- Uploader + Acciones -->
        <div class="card uploader-card">
          <h2>2. Sube tu foto</h2>
          <div id="drop" class="drop">
            <button id="removeBtn" class="close-btn" style="display:none" aria-label="Quitar imagen">
              <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
            <div id="drop-text">
              <div style="font-weight:700;font-size:18px;margin-bottom:6px">Arrastra tu foto o haz clic</div>
              <div class="hint">También puedes pegar una imagen desde el portapapeles.</div>
            </div>
            
            <img id="imagePreview" class="image-preview" alt="Vista previa" />
            
            <input id="fileInput" type="file" accept="image/jpeg, image/png, image/webp" style="display:none" />
            
            <div class="progress-bar" id="progressBar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="controls" style="margin-top: 15px;">
              <button id="chooseBtn" class="btn">Elegir imagen</button>
              <button id="runBtn" class="btn" style="display:none">✨ Aplicar Peinado</button>
              <span id="status" class="helper"></span>
              <div id="errorMessage" class="error-message"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Resultados -->
      <div class="result-container" id="resultContainer" style="display:none;">
        <div class="result-title">¡Tu nuevo look!</div>
        <div class="result-image-wrapper">
          <img id="resultImage" alt="Resultado del peinado" />
        </div>
        <div class="controls" style="margin-top:20px;justify-content:center;display:flex;gap:15px;">
          <button id="downloadBtn" class="btn">Descargar</button>
          <button id="startOverBtn" class="mini-btn">Probar otro</button>
        </div>
      </div>
    </section>

    <section class="section">
        <div class="container alt">
          <div class="text">
            <h2>¿Cómo funciona?</h2>
            <p>Nuestra IA analiza tu foto y el peinado que has elegido para crear una imagen realista de cómo te verías. Es la forma perfecta de experimentar sin riesgos antes de ir a la peluquería.</p>
          </div>
        </div>
      </section>
  </main>

  <footer>
    <div class="container">
      © <span id="year"></span> HAIR Style · Creado como demo con Gemini. La clave de API se almacena localmente en tu navegador.
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    // ============ Utilidades UI ============ 
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => [...el.querySelectorAll(s)];
    const toast = (msg, ms=3000) => {
      const el = $('#toast'); el.textContent = msg; el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), ms);
    };

    // ============ Tema claro/oscuro ============ 
    const themeBtn = $('#themeBtn');
    const iconSun = $('#iconSun');
    const iconMoon = $('#iconMoon');
    function applyTheme(t){
      if(t==='dark'){ document.body.classList.add('dark'); iconSun.style.display='none'; iconMoon.style.display='block'; }
      else { document.body.classList.remove('dark'); iconSun.style.display='block'; iconMoon.style.display='none'; }
      localStorage.setItem('theme', t);
    }
    const storedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
    applyTheme(storedTheme);
    themeBtn.addEventListener('click',()=>applyTheme(document.body.classList.contains('dark')?'light':'dark'));

    // ============ Año footer ============ 
    $('#year').textContent = new Date().getFullYear();

    // ============ DATOS DE PEINADOS ============
    const hairstyles = [
      { name: "Bob", image: "/images/bob.jpeg", description: "Un clásico atemporal, el corte Bob se caracteriza por su línea recta y longitud que suele llegar a la mandíbula." },
      { name: "Undercut", image: "/images/undercut.jpeg", description: "Moderno y atrevido, el Undercut mantiene el cabello más largo en la parte superior mientras los lados y la nuca están rapados." },
      { name: "Mullet", image: "/images/mullet.jpeg", description: "Corto por delante, largo por detrás. El Mullet ha vuelto con fuerza, ofreciendo un estilo retro y rebelde." },
      { name: "Pixie", image: "/images/pixie.jpeg", description: "Un corte corto y chic que resalta las facciones. Es versátil y puede ser tanto elegante como desenfadado." },
      { name: "Ondas Beach", image: "/images/ondas-beach.jpeg", description: "Perfecto para un look relajado y veraniego, las ondas playeras aportan textura y volumen natural al cabello." },
      { name: "Shag", image: "/images/shag.jpeg", description: "Un corte a capas con mucho movimiento y textura, ideal para un estilo bohemio y con personalidad." }
    ];

    let selectedHairstyle = null;
    const hairstylesGrid = $('#hairstylesGrid');
    const hairstyleDescriptionDisplay = $('#hairstyle-description-display');

    function initHairstyles() {
      hairstylesGrid.innerHTML = '';
      hairstyles.forEach((hairstyle, index) => {
        const item = document.createElement('div');
        item.className = 'hairstyle-item';
        item.dataset.index = index;
        item.innerHTML = `
          <img src="${hairstyle.image}" alt="${hairstyle.name}">
          <div class="hairstyle-name">${hairstyle.name}</div>
        `;
        item.addEventListener('click', () => selectHairstyle(item, hairstyle));
        hairstylesGrid.appendChild(item);
      });
    }

    function selectHairstyle(element, hairstyle) {
      $$('.hairstyle-item').forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
      selectedHairstyle = hairstyle;
      hairstyleDescriptionDisplay.textContent = selectedHairstyle.description;
      toast(`Peinado seleccionado: ${selectedHairstyle.name}`);
    }

    // ============ API Key ============ 
    const apiKeyInput = $('#apiKeyInput');
    const saveKeyBtn = $('#saveKeyBtn');
    apiKeyInput.value = localStorage.getItem('GEMINI_API_KEY') || '';
    saveKeyBtn.addEventListener('click', ()=> {
      localStorage.setItem('GEMINI_API_KEY', apiKeyInput.value.trim());
      toast('API Key guardada en este navegador');
    });

    // ============ Uploader y elementos ============ 
    const fileInput = $('#fileInput');
    const drop = $('#drop');
    const dropText = $('#drop-text');
    const chooseBtn = $('#chooseBtn');
    const runBtn = $('#runBtn');
    const removeBtn = $('#removeBtn');
    const statusEl = $('#status');
    const errorMessage = $('#errorMessage');
    const downloadBtn = $('#downloadBtn');
    const startOverBtn = $('#startOverBtn');
    const imagePreview = $('#imagePreview');
    const progressBar = $('#progressBar');
    const progressFill = $('#progressFill');
    const resultContainer = $('#resultContainer');
    const resultImage = $('#resultImage');

    let currentBeforeDataUrl = null;
    let currentBeforeMime = null;

    // ============ Event Listeners ============
    chooseBtn.addEventListener('click', ()=>fileInput.click());
    drop.addEventListener('click', e=> {
      if(e.target.closest('.controls') || e.target.closest('#removeBtn')) return;
      fileInput.click();
    });

    removeBtn.addEventListener('click', resetUploader);
    startOverBtn.addEventListener('click', resetAll);

    ['dragenter','dragover'].forEach(evt=>drop.addEventListener(evt, e=>{e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover');}));
    ['dragleave','drop'].forEach(evt=>drop.addEventListener(evt, e=>{e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover');}));
    drop.addEventListener('drop', e=> {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f) handleFile(f);
    });
    
    document.addEventListener('paste', e=> {
      const items = e.clipboardData?.items;
      if(!items) return;
      for(const it of items){
        if(it.type.startsWith('image/')){
          const f = it.getAsFile(); if(f) { handleFile(f); break; }
        }
      }
    });
    
    fileInput.addEventListener('change', e=> {
      const f = e.target.files[0]; if(f) handleFile(f);
    });

    // ============ Manejo de archivos y UI ============
    function resetUploader() {
      drop.classList.remove('image-loaded');
      imagePreview.style.display = 'none';
      imagePreview.src = '';
      dropText.style.display = 'block';
      chooseBtn.style.display = 'inline-block';
      runBtn.style.display = 'none';
      removeBtn.style.display = 'none';
      progressBar.style.display = 'none';
      statusEl.textContent = '';
      errorMessage.style.display = 'none';
      currentBeforeDataUrl = null;
      currentBeforeMime = null;
    }

    function resetAll() {
        resetUploader();
        resultContainer.style.display = 'none';
        resultImage.src = '';
        $$('.hairstyle-item').forEach(el => el.classList.remove('selected'));
        selectedHairstyle = null;
        hairstyleDescriptionDisplay.textContent = 'Selecciona un corte para ver su descripción.';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function handleFile(file){
      if(!file || !file.type.startsWith('image/')){ 
        showError('Selecciona un archivo de imagen válido (JPG, PNG, WEBP)'); 
        return; 
      }
      
      if(file.size > 10 * 1024 * 1024) {
        showError('La imagen es demasiado grande. Máximo 10MB.');
        return;
      }
      
      hideError();
      const reader = new FileReader();
      reader.onload = e=> {
        currentBeforeDataUrl = e.target.result;
        currentBeforeMime = file.type;
        
        imagePreview.src = currentBeforeDataUrl;
        imagePreview.style.display = 'block';
        dropText.style.display = 'none';
        
        drop.classList.add('image-loaded');
        chooseBtn.style.display = 'none';
        runBtn.style.display = 'inline-block';
        removeBtn.style.display = 'flex';
        
        statusEl.textContent = 'Imagen cargada. Lista para aplicar el peinado.';
      };
      reader.readAsDataURL(file);
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }

    function hideError() {
      errorMessage.style.display = 'none';
    }

    function updateProgress(percent) {
      progressFill.style.width = `${percent}%`;
      progressBar.style.display = percent > 0 ? 'block' : 'none';
    }

    // ========= Función para llamar a Gemini =========
    async function applyHairstyleWithGemini({apiKey, imageDataUrl, mimeType}) {
      if (!apiKey) throw new Error('API Key no configurada.');
      if (!imageDataUrl) throw new Error('No hay imagen para procesar.');
      if (!selectedHairstyle) throw new Error('No se ha seleccionado ningún peinado.');
      
      const base64 = imageDataUrl.split(',')[1];
      if (!base64) throw new Error('Formato de imagen inválido.');

      const prompt = `Aplica el peinado "${selectedHairstyle.name}" a la persona en la foto. La imagen final debe mostrar a la persona de frente, en una pose relajada, centrada y con un fondo blanco y limpio. El objetivo es visualizar claramente cómo quedaría el peinado en el usuario.`;

      const payload = {
        contents: [
          {
            role: "user",
            parts: [
              { text: prompt },
              { inlineData: { mimeType: mimeType || "image/jpeg", data: base64 } }
            ]
          }
        ],
        generationConfig: {
          responseModalities: ["IMAGE"],
          maxOutputTokens: 2048,
          temperature: 0.1
        }
      };

      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${encodeURIComponent(apiKey)}`;
      
      const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorText = await response.text();
        let errorJson;
        try {
            errorJson = JSON.parse(errorText);
        } catch(e) {
            throw new Error(`Error HTTP ${response.status}: ${errorText}`);
        }
        throw new Error(errorJson.error?.message || `Error HTTP ${response.status}`);
      }

      const data = await response.json();
      
      const imagePart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
      if (!imagePart) {
        console.error('Respuesta completa:', JSON.stringify(data, null, 2));
        throw new Error('La API no devolvió una imagen en el formato esperado.');
      }

      return `data:${imagePart.inlineData.mimeType};base64,${imagePart.inlineData.data}`;
    }

    // ========= Ejecutar aplicación de peinado =========
    runBtn.addEventListener('click', async ()=> {
      const apiKey = (apiKeyInput.value || localStorage.getItem('GEMINI_API_KEY') || '').trim();
      if(!apiKey){ 
        showError('Introduce tu GEMINI_API_KEY y pulsa Guardar.'); 
        return; 
      }
      if (!currentBeforeDataUrl) {
        showError('Por favor, carga una imagen primero.');
        return;
      }
      if (!selectedHairstyle) {
        showError('Por favor, selecciona un estilo de peinado.');
        return;
      }

      try {
        hideError();
        runBtn.disabled = true;
        runBtn.textContent = 'Procesando...';
        statusEl.textContent = 'Enviando a la IA...';
        updateProgress(25);

        const resultDataUrl = await applyHairstyleWithGemini({
          apiKey, 
          imageDataUrl: currentBeforeDataUrl, 
          mimeType: currentBeforeMime
        });

        updateProgress(90);
        statusEl.textContent = 'Generando resultado...';

        resultImage.src = resultDataUrl;
        resultContainer.style.display = 'block';
        
        updateProgress(100);
        statusEl.textContent = '¡Peinado aplicado!';
        toast('¡Nuevo look creado! ✅');
        
        resultImage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => updateProgress(0), 2000);

      } catch(err) {
        console.error('Error al aplicar peinado:', err);
        updateProgress(0);
        
        let errorMsg = err?.message || 'Error desconocido';
        if (errorMsg.includes('API_KEY_INVALID')) {
          errorMsg = 'API Key inválida o mal formada. Verifícala.';
        } else if (errorMsg.includes('PERMISSION_DENIED')) {
          errorMsg = 'Permiso denegado. Verifica que tu API Key esté habilitada para el modelo Gemini.';
        }
        
        showError(errorMsg);
        statusEl.textContent = 'Error en el proceso.';
        
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = '✨ Aplicar Peinado';
      }
    });

    // ========= Descargar resultado =========
    downloadBtn.addEventListener('click', async ()=> {
      if (!resultImage.src) {
        toast('No hay imagen para descargar.');
        return;
      }
      try {
        const response = await fetch(resultImage.src);
        const blob = await response.blob();
        const objectUrl = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = objectUrl;
        a.download = `hair-style-${selectedHairstyle.name.toLowerCase().replace(/\s+/g, '-')}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        
        setTimeout(() => URL.revokeObjectURL(objectUrl), 100);
        toast('Descarga iniciada ⬇️');
        
      } catch (err) {
        console.error('Error al descargar:', err);
        toast('Error al descargar la imagen.');
      }
    });

    // Inicializar la aplicación
    initHairstyles();
  </script>
</body>
</html>